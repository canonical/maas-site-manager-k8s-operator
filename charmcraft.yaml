# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: maas-site-manager-k8s
type: charm
title: MAAS Site Manager Kubernetes Operator
summary: A Juju charm to run MAAS Site Manager on Kubernetes.
description: |
    A Juju-operated MAAS Site Manager that orchestrates image provisioning on
    many MAAS sites.

links:
    documentation: https://discourse.charmhub.io/t/maas-site-manager-k8s-docs-index/13710
    website:
        - https://charmhub.io/maas-site-manager-k8s
    source:
        - https://github.com/canonical/maas-site-manager-k8s-operator
    issues:
        - https://github.com/canonical/maas-site-manager-k8s-operator/issues

base: ubuntu@24.04
build-base: ubuntu@24.04
platforms:
    amd64:
        build-on: [amd64]
        build-for: [amd64]

parts:
    charm:
        build-packages: [cargo, rustc]
        override-build: |
            set -e
            snap install rustup --classic
            rustup set profile minimal
            rustup default 1.90.0
            craftctl default

    grafana-dashboards:
        plugin: dump
        source: https://github.com/canonical/maas-grafana-dashboards
        source-depth: 1
        source-type: git
        source-subdir: maas-site-manager
        organize:
            "*": src/grafana_dashboards/
        prime:
            - src/grafana_dashboards/*

assumes:
    - juju >= 3.6
    - k8s-api

containers:
    site-manager:
        resource: site-manager-image

resources:
    site-manager-image:
        type: oci-image
        description: MAAS Site Manager OCI image
        upstream-source: ghcr.io/canonical/maas-site-manager:1.0.0

peers:
    site-manager-cluster:
        interface: site_manager_peers
        optional: false

requires:
    database:
        interface: postgresql_client
        limit: 1
        optional: false
    logging-consumer:
        interface: loki_push_api
        optional: true
    ingress:
        interface: ingress
        limit: 1
        optional: false
    tracing:
        interface: tracing
        limit: 1
        optional: true
    s3:
        interface: s3
        limit: 1
        optional: false
    receive-ca-cert:
        interface: certificate_transfer
        optional: true

provides:
    metrics-endpoint:
        interface: prometheus_scrape
    grafana-dashboard:
        interface: grafana_dashboard
    maas-site-manager:
        interface: site_manager_enroll

config:
    options:
        log-level:
            description: |
                Configures the log level of WSGI HTTP Server.

                Acceptable values are: "info", "debug", "warning", "error" and "critical"
            default: "info"
            type: string
        temporal-server-address:
            description: The host:port for the temporal server
            default: localhost:7233
            type: string
        temporal-namespace:
            description: The namespace to use for running Temporal workflows
            default: msm-namespace
            type: string
        temporal-task-queue:
            description: The task queue for Temporal workers to look for jobs in
            default: msm-queue
            type: string
        temporal-tls-root-cas:
            description: Root certificate authority (CA) certificates for TLS communication.
            default: ""
            type: string
        environment:
            description: |
                This configuration is used to set environment variables for the MAAS Site
                Manager application settings. The format is a YAML list where each item
                is a mapping with keys "name" and "value" representing the environment
                variable name and its value. Allowable names and default values are shown
                below.

                ```yaml
                - name: MSM_CONN_LOST_THRESHOLD_SEC
                  value: 600
                - name: MSM_HEARTBEAT_INTERVAL_SEC
                  value: 300
                - name: MSM_METRICS_REFRESH_INTERVAL_SEC
                  value: 300
                - name: MSM_IMAGE_SERVING_CHUNK_SIZE_BYTES
                  value: 5242880 # 5 MiB
                ```
            type: string
actions:
    create-admin:
        description: Create an administrator account.
        params:
            username:
                type: string
                description: Username for the new account.
            fullname:
                type: string
                description: Full name for this user.
            password:
                type: string
                description: A password for this user.
            email:
                type: string
                description: Specifies the email of the admin user.
        required:
            - username
            - password
            - email
